# Technical Documentation of the TICK Stack in LISA

## Table of Contents
1. [Introduction](#introduction)
2. [General Architecture](#general-architecture)
3. [Components](#components)
   - [Telegraf](#telegraf)
   - [InfluxDB](#influxdb)
   - [Chronograf](#chronograf)
   - [Kapacitor](#kapacitor)
4. [Integration with LISA](#integration-with-lisa)
5. [Specific Configurations](#specific-configurations)
6. [Data Flow](#data-flow)
7. [Export API](#export-api)
8. [Data Retention Management](#data-retention-management)
9. [Alerts and Monitoring](#alerts-and-monitoring)
10. [Scalability](#scalability)
11. [Maintenance and Backup](#maintenance-and-backup)

---

## Introduction

The TICK stack (Telegraf, InfluxDB, Chronograf, Kapacitor) has been implemented in LISA (Living-lab Integrated Sensing Architecture) to provide a robust and scalable time-series data management solution, specifically designed to capture, store, visualize, and process MQTT/Zigbee sensor data.

This stack enables LISA to meet key requirements:
- Capture data from up to 10,000 different sensors
- Store data for a minimum period of 90 days
- Implement a buffer of 1,000 points before writing to the database
- Real-time monitoring and alerting
- Flexible data export for analysis

---

## General Architecture

![TICK Stack Architecture](../attached_assets/tick_architecture.png)

The TICK stack architecture in LISA is designed to optimize both data capture and processing in a clinical/medical environment, where accuracy and reliability are critical.

The entire stack runs on the application server (192.168.0.20) to reduce MQTT data capture latency and simplify architecture, while the database server (192.168.0.21) is dedicated to PostgreSQL and Redis.

---

## Components

### Telegraf

**Function**: Data collector capturing metrics and events from multiple sources.

**Configuration in LISA**:
- Implements a 1,000-point buffer (`metric_batch_size = 1000`)
- Captures MQTT data from all configured topics
- Specific configuration for Zigbee sensors
- Collection interval: 10 seconds

Telegraf subscribes to all relevant MQTT topics, processing JSON messages and adding tags to facilitate filtering and querying later.

### InfluxDB

**Function**: Time-series database optimized for high-availability, high-performance data.

**Configuration in LISA**:
- 90-day retention policy
- Configured to handle high throughput from sensors
- Dedicated organization and bucket for MQTT data
- Token-based authentication for security

InfluxDB stores all measurements with precise timestamps, allowing efficient time-based queries and enabling aggregation and downsampling.

### Chronograf

**Function**: User interface for data visualization and management of InfluxDB and Kapacitor.

**Configuration in LISA**:
- Preconfigured dashboards for different sensor types
- System status monitoring
- Data explorer for ad-hoc queries
- Interface for alert management

Chronograf provides a visual interface for admins and technical users to explore data and configure the system without deep Flux query knowledge.

### Kapacitor

**Function**: Real-time data processing engine for alerts and transformations.

**Configuration in LISA**:
- TICKscripts for anomaly detection in sensors
- Alerts configured for critical thresholds (temperature, humidity, etc.)
- Notifications via MQTT for integration with LISA’s alert system
- Continuous stream processing

Kapacitor executes continuous queries on incoming data, detecting anomalies and triggering automatic actions without human intervention.

---

## Integration with LISA

The TICK stack integrates with the main LISA application through:

1. **Data Capture**: Telegraf captures the same MQTT data as the main application, providing redundancy.
2. **Query API**: A dedicated service (`influxdb-service.js`) allows the main application to query historical data from InfluxDB.
3. **Export**: Endpoints to export sensor data in CSV and JSON formats, integrated with existing export functionality.
4. **Alerts**: Alerts generated by Kapacitor are published to specific MQTT topics monitored by the main application.

This integration is non-invasive, allowing LISA to continue using in-memory storage (MemStorage) while benefiting from the TICK stack’s additional capabilities.

---

## Specific Configurations

### Telegraf Configuration for 1,000-Point Buffer

```toml
[agent]
  interval = "10s"
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  flush_interval = "60s"
````

This ensures Telegraf accumulates 1,000 data points before writing to InfluxDB, optimizing performance and reducing database load.

### InfluxDB Retention Configuration (90 days)

The `setup-retention.sh` script automatically configures the retention policy:

```bash
# Update bucket retention policy to 90 days (7776000 seconds)
curl -s -X PATCH \
  -H "Authorization: Token ${TOKEN}" \
  -H "Content-Type: application/json" \
  "http://influxdb:8086/api/v2/buckets/${BUCKET_ID}" \
  -d '{
    "retentionRules": [
      {
        "type": "expire",
        "everySeconds": 7776000,
        "shardGroupDurationSeconds": 86400
      }
    ]
  }'
```

---

## Data Flow

Data flow in the TICK stack follows this pattern:

1. **Capture**: Sensors publish data to the MQTT broker (192.168.0.20:1883)
2. **Collection**: Telegraf subscribes to relevant topics and collects data
3. **Buffering**: Telegraf accumulates 1,000 points before proceeding
4. **Storage**: Data is written to InfluxDB with proper tags and fields
5. **Processing**: Kapacitor processes data in real-time for anomaly detection
6. **Alerting**: Kapacitor sends alerts via MQTT if anomalies are detected
7. **Visualization**: Data can be viewed through Chronograf
8. **Query**: LISA application queries historical data via InfluxDB API
9. **Export**: Data can be exported for external analysis

---

## Export API

The export API provides three main endpoints:

1. **GET /api/sensor-data/latest**: Retrieves the latest sensor data
2. **GET /api/sessions/:sessionId/export-sensor-data**: Exports sensor data for a specific session in CSV or JSON
3. **GET /api/sessions/:sessionId/export-all**: Exports both sensor data and camera recordings as a ZIP file

This API integrates with LISA’s session system and complements existing export functionality.

---

## Data Retention Management

The 90-day retention policy is configured during InfluxDB initialization and verified/corrected using `setup-retention.sh`.

Critical data requiring longer storage can be exported permanently using the API in standard formats (CSV/JSON).

---

## Alerts and Monitoring

Alert system uses Kapacitor TICKscripts to define alert conditions:

```js
// Temperature alerts for sensors
var temp_data = stream
    |from()
        .database(db)
        .measurement('zigbee_sensor_state')
        .groupBy('topic')
    |filter(lambda: "temperature" != 0)
    |alert()
        .id('{{ index .Tags "topic" }}/temp')
        .message('Temperature out of range: {{ .Level }} - Value: {{ index .Fields "temperature" }}')
        .warn(lambda: "temperature" > temp_high OR "temperature" < temp_low)
        .crit(lambda: "temperature" > (temp_high + 10) OR "temperature" < (temp_low - 10))
        .topic('lisa/alerts/temperature')
```

Defined alerts include:

* Out-of-range temperatures
* Out-of-range humidity
* Prolonged motion detection (possible intrusion or emergency)

---

## Scalability

The TICK stack is designed to scale up to 10,000 sensors:

* **Vertical Scaling**: Increase CPU/memory for InfluxDB
* **Horizontal Scaling**: Add more Telegraf instances to distribute capture load
* **Partitioning**: Use retention/downsampling for older data
* **Query Optimization**: Use tags and indexes selectively to improve performance

For extreme requirements, the architecture allows distributing components across multiple servers.

---

## Maintenance and Backup

To ensure data integrity:

1. **Automated Backups**: Schedule daily backups of InfluxDB buckets
2. **Health Monitoring**: Configure alerts for system issues
3. **Compaction**: Schedule periodic maintenance to optimize storage
4. **Updates**: Documented process for safe component upgrades

Maintenance should occur during low-use windows to minimize impact.

---

**Technical Document created for the LISA Project - Living-lab Integrated Sensing Architecture**
**Date: April 21, 2025**
**Version: 1.0**

